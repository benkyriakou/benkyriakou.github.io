<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="theme-color" content="#333"/>
    <meta name="description" content="Some notes on dealing with timezones robustly in Ruby/Rails."/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1"/>
    <link rel="canonical" href="https://benkyriakou.com/posts/whats-the-time-mr-matsumoto"/>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
    <title>What's the time Mr Matsumoto? | Ben Kyriakou</title>
    <link rel="stylesheet" href="/css/style.css" type="text/css"/>
    <meta property="og:url" content="http://benkyriakou.com/posts/whats-the-time-mr-matsumoto"/>
    <meta property="og:title" content="What's the time Mr Matsumoto?"/>
    <meta property="og:description" content="Some notes on dealing with timezones robustly in Ruby/Rails."/>
    <meta property="og:image" content="http://benkyriakou.com/images/global/twitter-card-image.png"/>
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:site" content="@benkyriakou"/>
    <meta name="twitter:title" content="What's the time Mr Matsumoto?"/>
    <meta name="twitter:description" content="Some notes on dealing with timezones robustly in Ruby/Rails."/>
    <meta name="twitter:image" content="http://benkyriakou.com/images/global/twitter-card-image.png"/>
    <script>
      window.onload = function() {
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-64337321-1', 'auto');
        ga('send', 'pageview');
      };
    </script>
  </head>
  <body>
    <div class="wrapper">
      <header class="site-header">
        <div class="center-wrapper">
          <nav>
            <ul class="site-header__items">
              <li class="site-header__item">
                <a href="/">Home</a>
              </li>
              <li class="site-header__item">
                <a href="/pdfs">PDFs</a>
              </li>
              <li class="site-header__item">
                <a href="/about">About</a>
              </li>
            </ul>
          </nav>
        </div>
      </header>
      <main class="center-wrapper">
    <article class="article"><time class="article__date" datetime="2023-05">May 2023</time><h1 class="article__header">What's the time Mr Matsumoto?</h1><div class="article__content">
        <p>An adaptation of a presentation I gave on writing robust code across timezones in Ruby/Rails. You can see the <a href="/pdfs/whats-the-time-mr-matsumoto.pdf">original presentation here</a>.</p>

        <p>Some things I've learned from writing cross-timezone code in Ruby. Thinking across timezones is hard; UTC isn't enough.</p>

        <p>Let's establish some common ground. Computers generally deal with time in UTC (<a href="https://en.wikipedia.org/wiki/Coordinated_Universal_Time">Coordinated Universal Time</a>). This is great if you're dealing with other computers that are also using UTC, but when dealing with the real world it isn't super useful. UTC represents a datum timezone at 0&#176; longitude, and isn't adjusted for DST (daylight savings time), so if you want to do something relative to a real time like 11am in Sydney you're going to have to deal with timezones.</p>

        <p>Real timezones are messy, but they're necessary if you want to represent times in the real world. For example, UTC is fine for tasks like "I want to run this job once an hour". However, what if you want t to run a job at 02:00. First, 02:00 in which timezone? Does it need to be adjusted for DST? Does it matter if it runs early/late? What if 02:00 doesn't exist on that day in that timezone?</p>

        <h2 id="section-what-tools-do-we-have-in-ruby">What tools do we have in Ruby?</h2>

        <ul>
          <li><a href="https://ruby-doc.org/current/Time.html">Time</a></li>
          <li><a href="https://ruby-doc.org/current/exts/date/Date.html">Date</a></li>
          <li><a href="https://ruby-doc.org/current/exts/date/DateTime.html">DateTime</a> (deprecated in favour of Time)</li>
        </ul>

        <p>Note that the core Ruby library does not include a TimeZone class.</p>

        <div class="highlight"><pre><span/><span class="o">&gt;</span> <span class="n">time</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
<span class="o">=&gt;</span> <span class="mi">2023</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mo">06</span> <span class="mi">16</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">08</span><span class="o">.</span><span class="mi">108773</span> <span class="o">+</span><span class="mo">0100</span>

<span class="o">&gt;</span> <span class="n">time</span><span class="o">.</span><span class="n">zone</span>
<span class="o">=&gt;</span> <span class="s2">"BST"</span>

<span class="o">&gt;</span> <span class="nb">require</span> <span class="s1">'date'</span>
<span class="o">&gt;</span> <span class="n">date</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Date: 2023-04-06 ((2460041j,0s,0n),+0s,2299161j)&gt;</span>
</pre></div><h2 id="section-enter-activesupport">Enter ActiveSupport</h2>

        <p>ActiveSupport in Rails provides us with some extensions to time which give us both a way of dealing explicitly with timezones (via <code>ActiveSupport::TimeZone</code>) and associating them with times (via <code>ActiveSupport::TimeWithZone</code>).</p>

        <div class="highlight"><pre><span/><span class="o">&gt;</span> <span class="nb">require</span> <span class="s1">'active_support'</span>
<span class="o">&gt;</span> <span class="nb">require</span> <span class="s1">'active_support/time'</span>
<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span>
<span class="o">=&gt;</span> <span class="kp">nil</span>
<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">find_zone!</span><span class="p">(</span><span class="s2">"UTC"</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;ActiveSupport::TimeZone:0x0000000105f456b8</span>
     <span class="vi">@name</span><span class="o">=</span><span class="s2">"UTC"</span><span class="p">,</span>
     <span class="vi">@tzinfo</span><span class="o">=</span><span class="c1">#&lt;TZInfo::DataTimezone: Etc/UTC&gt;,</span>
     <span class="vi">@utc_offset</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span>
<span class="o">=&gt;</span> <span class="no">Thu</span><span class="p">,</span> <span class="mo">06</span> <span class="no">Apr</span> <span class="mi">2023</span> <span class="mi">15</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">55</span><span class="o">.</span><span class="mi">127999000</span> <span class="no">UTC</span> <span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span>
<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span> <span class="o">+</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span>
<span class="o">=&gt;</span> <span class="no">Fri</span><span class="p">,</span> <span class="mo">07</span> <span class="no">Apr</span> <span class="mi">2023</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mo">05</span><span class="o">.</span><span class="mi">759982000</span> <span class="no">UTC</span> <span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span>
<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">in_time_zone</span><span class="p">(</span><span class="s2">"Australia/Sydney"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="no">Fri</span><span class="p">,</span> <span class="mo">07</span> <span class="no">Apr</span> <span class="mi">2023</span> <span class="mo">01</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">12</span><span class="o">.</span><span class="mi">413260000</span> <span class="no">AEST</span> <span class="o">+</span><span class="mi">10</span><span class="p">:</span><span class="mo">00</span>
</pre></div><p>When using ActiveSupport we can configure the default timezone (Rails will do this for you):</p>

        <div class="highlight"><pre><span/><span class="o">&gt;</span> <span class="nb">require</span> <span class="s1">'active_support'</span>
<span class="o">&gt;</span> <span class="nb">require</span> <span class="s1">'active_support/time'</span>
<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span>
<span class="o">=&gt;</span> <span class="kp">nil</span>

<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">find_zone!</span><span class="p">(</span><span class="s2">"UTC"</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">class</span>
<span class="o">=&gt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TimeZone</span>

<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span>
<span class="o">=&gt;</span> <span class="no">Thu</span><span class="p">,</span> <span class="mo">06</span> <span class="no">Apr</span> <span class="mi">2023</span> <span class="mi">15</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">55</span><span class="o">.</span><span class="mi">127999000</span> <span class="no">UTC</span> <span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span>

<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">class</span>
<span class="o">=&gt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TimeWithZone</span>
</pre></div><h2 id="section-a-note-on-timezones">A note on timezones</h2>

        <p>Where does the computer's notion of timezones come from? On linux-like systems, they're stored in <code>/usr/share/zoneinfo/</code>:</p>

        <div class="highlight"><pre><span/>&gt; tree /usr/share/zoneinfo/
/usr/share/zoneinfo/
&#9500;&#9472;&#9472; +VERSION
&#9500;&#9472;&#9472; Africa
&#9474;   &#9500;&#9472;&#9472; Abidjan
&#9474;   &#9500;&#9472;&#9472; Accra
&#9474;   &#9500;&#9472;&#9472; Addis_Ababa
&#9474;   &#9500;&#9472;&#9472; Algiers
&#9474;   &#9500;&#9472;&#9472; Asmara
&#9474;   &#9500;&#9472;&#9472; Asmera
&#9474;   &#9500;&#9472;&#9472; Bamako
&#9474;   &#9500;&#9472;&#9472; Bangui
&#9474;   &#9500;&#9472;&#9472; Banjul
&#9474;   &#9500;&#9472;&#9472; Bissau
&#9474;   &#9500;&#9472;&#9472; Blantyre
</pre></div><p>What do these tell us?</p>

        <div class="highlight"><pre><span/>&gt; zdump -v /usr/share/zoneinfo/Europe/London | tail -n 6
/usr/share/zoneinfo/Europe/London  Sun Mar 29 00:59:59 2037 UTC = Sun Mar 29 00:59:59 2037 GMT isdst=0
/usr/share/zoneinfo/Europe/London  Sun Mar 29 01:00:00 2037 UTC = Sun Mar 29 02:00:00 2037 BST isdst=1
/usr/share/zoneinfo/Europe/London  Sun Oct 25 00:59:59 2037 UTC = Sun Oct 25 01:59:59 2037 BST isdst=1
/usr/share/zoneinfo/Europe/London  Sun Oct 25 01:00:00 2037 UTC = Sun Oct 25 01:00:00 2037 GMT isdst=0
/usr/share/zoneinfo/Europe/London  Mon Jan 18 03:14:07 2038 UTC = Mon Jan 18 03:14:07 2038 GMT isdst=0
/usr/share/zoneinfo/Europe/London  Tue Jan 19 03:14:07 2038 UTC = Tue Jan 19 03:14:07 2038 GMT isdst=0
</pre></div><p>If you&#8217;re curious about the last two lines, Google the "Epochalypse" (yes, that&#8217;s a thing). If you're using a language like Go you'll see that it represents datetimes as an int64 to avoid this problem</p>

        <p>By default TZInfo in Ruby actually uses the <code>tzinfo-data</code> gem as its source. You can force it to use zoneinfo with <code>TZInfo::DataSource.set(:zoneinfo)</code></p>

        <div class="highlight"><pre><span/><span class="o">&gt;</span> <span class="nb">require</span> <span class="s2">"tzinfo"</span>
<span class="o">&gt;</span> <span class="n">london</span> <span class="o">=</span> <span class="no">TZInfo</span><span class="o">::</span><span class="no">Timezone</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"Europe/London"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;TZInfo::DataTimezone: Europe/London&gt;</span>
<span class="o">&gt;</span> <span class="n">london</span><span class="o">.</span><span class="n">canonical_identifier</span>
<span class="o">=&gt;</span> <span class="s2">"Europe/London"</span>
<span class="o">&gt;</span> <span class="n">london</span><span class="o">.</span><span class="n">observed_utc_offset</span>
<span class="o">=&gt;</span> <span class="mi">3600</span>
<span class="o">&gt;</span> <span class="n">london</span><span class="o">.</span><span class="n">now</span>
<span class="o">=&gt;</span> <span class="mi">2023</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mo">07</span> <span class="mi">22</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">16</span><span class="o">.</span><span class="mo">077745</span> <span class="o">+</span><span class="mo">0100</span>

<span class="c1"># Also available on an ActiveSupport::TimeZone:</span>

<span class="o">&gt;</span> <span class="n">london</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">find_zone!</span><span class="p">(</span><span class="s2">"Europe/London"</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">london</span><span class="o">.</span><span class="n">tzinfo</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;TZInfo::DataTimezone: Europe/London&gt;</span>
</pre></div><h2 id="section-what-about-activerecord">What about ActiveRecord?</h2>

        <p>There are actually two types of timestamp column you can create with Rails (in Postgres, at least):</p>

        <div class="highlight"><pre><span/>&gt; rails generate model widget \
  title:string utc_timestamp:timestamp tz_timestamp:timestamptz

---

class CreateWidgets &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :widgets do |t|
      t.string :title
      t.timestamp :utc_timestamp
      t.timestamptz :tz_timestamp

      t.timestamps
    end
  end
end
</pre></div><p>The difference is that, in the database, one is stored with timezone information:</p>

        <div class="highlight"><pre><span/>Column     |              Type
-----------+-------------------------------
           | bigint
le         | character varying
_timestamp | timestamp without time zone
timestamp  | timestamp with time zone
ated_at    | timestamp(6) without time zone
ated_at    | timestamp(6) without time zone
</pre></div><p>By default this will use the timezone set in the database:</p>

        <div class="highlight"><pre><span/>rails_test_development=&gt; SELECT * FROM widgets;
-[ RECORD 1 ]-+------------------------------
id            | 1
title         | my_widget
utc_timestamp | 2023-04-08 20:07:34.545792
tz_timestamp  | 2023-04-08 21:07:34.545792+01

rails_test_development=&gt; SHOW TIMEZONE;
-[ RECORD 1 ]-----------
TimeZone | Europe/London
</pre></div><p>This doesn't <em>actually</em> matter in Rails since it will convert everything to UTC (or your configured Rails timezone) on models:</p>

        <div class="highlight"><pre><span/><span class="n">now</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">find_zone!</span><span class="p">(</span><span class="s2">"Australia/Sydney"</span><span class="p">)</span><span class="o">.</span><span class="n">now</span>

<span class="no">Widget</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
  <span class="ss">title</span><span class="p">:</span> <span class="s2">"my_widget"</span><span class="p">,</span>
  <span class="ss">tz_timestamp</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
  <span class="ss">utc_timestamp</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1">#&lt;Widget:0x0000000106d14780</span>
 <span class="nb">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="ss">title</span><span class="p">:</span> <span class="s2">"my_widget"</span><span class="p">,</span>
 <span class="ss">utc_timestamp</span><span class="p">:</span> <span class="no">Sat</span><span class="p">,</span> <span class="mi">08</span> <span class="no">Apr</span> <span class="mi">2023</span> <span class="mi">20</span><span class="p">:</span><span class="mo">07</span><span class="p">:</span><span class="mi">34</span><span class="o">.</span><span class="mi">545792000</span> <span class="no">UTC</span> <span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span>
 <span class="ss">tz_timestamp</span><span class="p">:</span> <span class="no">Sat</span><span class="p">,</span> <span class="mi">08</span> <span class="no">Apr</span> <span class="mi">2023</span> <span class="mi">20</span><span class="p">:</span><span class="mo">07</span><span class="p">:</span><span class="mi">34</span><span class="o">.</span><span class="mi">545792000</span> <span class="no">UTC</span> <span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span>
 <span class="ss">created_at</span><span class="p">:</span> <span class="no">Sat</span><span class="p">,</span> <span class="mi">08</span> <span class="no">Apr</span> <span class="mi">2023</span> <span class="mi">20</span><span class="p">:</span><span class="mo">07</span><span class="p">:</span><span class="mi">57</span><span class="o">.</span><span class="mi">445968000</span> <span class="no">UTC</span> <span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span>
 <span class="ss">updated_at</span><span class="p">:</span> <span class="no">Sat</span><span class="p">,</span> <span class="mi">08</span> <span class="no">Apr</span> <span class="mi">2023</span> <span class="mi">20</span><span class="p">:</span><span class="mo">07</span><span class="p">:</span><span class="mi">57</span><span class="o">.</span><span class="mi">445968000</span> <span class="no">UTC</span> <span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">&gt;</span>
</pre></div><p>We can see this in the SQL executed:</p>

        <div class="highlight"><pre><span/><span class="no">Widget</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
  <span class="ss">title</span><span class="p">:</span> <span class="s2">"my_widget"</span><span class="p">,</span>
  <span class="ss">tz_timestamp</span><span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">find_zone!</span><span class="p">(</span><span class="s2">"Europe/London"</span><span class="p">)</span><span class="o">.</span><span class="n">now</span><span class="p">,</span>
  <span class="ss">utc_timestamp</span><span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">find_zone!</span><span class="p">(</span><span class="s2">"Australia/Sydney"</span><span class="p">)</span><span class="o">.</span><span class="n">now</span><span class="p">,</span>
<span class="p">)</span>

<span class="no">INSERT</span> <span class="no">INTO</span> <span class="s2">"widgets"</span> <span class="p">(</span><span class="s2">"title"</span><span class="p">,</span> <span class="s2">"utc_timestamp"</span><span class="p">,</span> <span class="s2">"tz_timestamp"</span><span class="p">,</span> <span class="s2">"created_at"</span><span class="p">,</span> <span class="s2">"updated_at"</span><span class="p">)</span>
<span class="no">VALUES</span> <span class="p">(</span><span class="vg">$1</span><span class="p">,</span> <span class="vg">$2</span><span class="p">,</span> <span class="vg">$3</span><span class="p">,</span> <span class="vg">$4</span><span class="p">,</span> <span class="vg">$5</span><span class="p">)</span> <span class="no">RETURNING</span> <span class="s2">"id"</span>
<span class="o">[</span>
  <span class="o">[</span><span class="s2">"title"</span><span class="p">,</span> <span class="s2">"my_widget"</span><span class="o">]</span><span class="p">,</span>
  <span class="o">[</span><span class="s2">"utc_timestamp"</span><span class="p">,</span> <span class="s2">"2023-04-27 15:25:04.389264"</span><span class="o">]</span><span class="p">,</span>
  <span class="o">[</span><span class="s2">"tz_timestamp"</span><span class="p">,</span> <span class="s2">"2023-04-27 15:25:04.382907"</span><span class="o">]</span><span class="p">,</span>
  <span class="o">[</span><span class="s2">"created_at"</span><span class="p">,</span> <span class="s2">"2023-04-27 15:25:04.392253"</span><span class="o">]</span><span class="p">,</span>
  <span class="o">[</span><span class="s2">"updated_at"</span><span class="p">,</span> <span class="s2">"2023-04-27 15:25:04.392253"</span><span class="o">]</span>
<span class="o">]</span>
</pre></div><p>The simplest thing is to store everything in the database as a <code>timestamp</code> and let Rails take care of the UTC conversion.</p>

        <h2 id="section-things-to-avoid">Things to avoid</h2>

        <h3 id="section-manual-utc-offsetting">Manual UTC offsetting</h3>

        <p>Especially don&#8217;t do this:</p>

        <div class="highlight"><pre><span/><span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">find_zone!</span><span class="p">(</span><span class="s2">"Europe/London"</span><span class="p">)</span><span class="o">.</span><span class="n">utc_offset</span>
<span class="o">=&gt;</span> <span class="mi">0</span>

<span class="o">&gt;</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span>
<span class="o">=&gt;</span> <span class="no">Fri</span><span class="p">,</span> <span class="mo">07</span> <span class="no">Apr</span> <span class="mi">2023</span>

<span class="o">&gt;</span> <span class="no">Timecop</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="s2">"01 November 2023"</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Time</span><span class="o">.</span><span class="n">find_zone!</span><span class="p">(</span><span class="s2">"Europe/London"</span><span class="p">)</span><span class="o">.</span><span class="n">utc_offset</span>
  <span class="k">end</span>
<span class="o">=&gt;</span> <span class="mi">0</span>
</pre></div><div class="highlight"><pre><span/><span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">find_zone!</span><span class="p">(</span><span class="s2">"Europe/London"</span><span class="p">)</span><span class="o">.</span><span class="n">tzinfo</span><span class="o">.</span><span class="n">base_utc_offset</span>
<span class="o">=&gt;</span> <span class="mi">0</span>
</pre></div><div class="highlight"><pre><span/><span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">find_zone!</span><span class="p">(</span><span class="s2">"Europe/London"</span><span class="p">)</span><span class="o">.</span><span class="n">tzinfo</span><span class="o">.</span><span class="n">observed_utc_offset</span>
<span class="o">=&gt;</span> <span class="mi">3600</span>

<span class="o">&gt;</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span>
<span class="o">=&gt;</span> <span class="no">Fri</span><span class="p">,</span> <span class="mo">07</span> <span class="no">Apr</span> <span class="mi">2023</span>
</pre></div><div class="highlight"><pre><span/><span class="o">&gt;</span> <span class="no">Timecop</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="s2">"01 November 2023"</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Time</span><span class="o">.</span><span class="n">find_zone!</span><span class="p">(</span><span class="s2">"Europe/London"</span><span class="p">)</span><span class="o">.</span><span class="n">tzinfo</span><span class="o">.</span><span class="n">observed_utc_offset</span>
  <span class="k">end</span>
<span class="o">=&gt;</span> <span class="mi">0</span>
</pre></div><h3 id="section-parse-methods"><code>.parse</code> methods</h3>

        <p>These are far too permissive in what they consider valid:</p>

        <div class="highlight"><pre><span/><span class="o">&gt;</span> <span class="no">Date</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">"Monday 26rd September 2016"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Date: 2016-09-26 ((2457658j,0s,0n),+0s,2299161j)&gt;</span>

<span class="o">&gt;</span> <span class="no">Date</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">"fri1feb3bc4pm+5"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Date: -0002-02-01 ((1720359j,0s,0n),+0s,2299161j)&gt;</span>

<span class="o">&gt;</span> <span class="no">Date</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">"2O15-O2-01"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Date: 2022-09-15 ((2459838j,0s,0n),+0s,2299161j)&gt;</span>

<span class="o">&gt;</span> <span class="no">Date</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">"20189"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="no">Tue</span><span class="p">,</span> <span class="mo">07</span> <span class="no">Jul</span> <span class="mi">2020</span>
</pre></div><p>Use the <code>iso8601</code> methods instead, or <code>strptime</code> for nonstandard formats:</p>

        <div class="highlight"><pre><span/><span class="o">&gt;</span> <span class="no">Date</span><span class="o">.</span><span class="n">iso8601</span><span class="p">(</span><span class="s2">"2022-01-01"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="no">Sat</span><span class="p">,</span> <span class="mo">01</span> <span class="no">Jan</span> <span class="mi">2022</span>

<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">iso8601</span><span class="p">(</span><span class="s2">"2022-01-01T12:00"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="no">Sat</span><span class="p">,</span> <span class="mo">01</span> <span class="no">Jan</span> <span class="mi">2022</span> <span class="mi">12</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">000000000</span> <span class="no">UTC</span> <span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span>

<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">iso8601</span>
<span class="o">=&gt;</span> <span class="s2">"2023-04-08T15:07:06Z"</span>

<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s2">"8 April 2023, 12:00"</span><span class="p">,</span> <span class="s2">"%d %B %Y, %k:%M"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="no">Sat</span><span class="p">,</span> <span class="mi">08</span> <span class="no">Apr</span> <span class="mi">2023</span> <span class="mi">12</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">000000000</span> <span class="no">UTC</span> <span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span>
</pre></div><h3 id="section-implicit-timezones-poor-conversion">"Implicit" timezones, poor conversion</h3>

        <p>Interpreting a datetime without specifying the timezone may give unexpected results:</p>

        <div class="highlight"><pre><span/><span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">iso8601</span><span class="p">(</span><span class="s2">"2022-06-17T16:00"</span><span class="p">)</span><span class="o">.</span><span class="n">in_time_zone</span><span class="p">(</span><span class="s2">"Europe/London"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="no">Fri</span><span class="p">,</span> <span class="mi">17</span> <span class="no">Jun</span> <span class="mi">2022</span> <span class="mi">16</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">000000000</span> <span class="no">BST</span> <span class="o">+</span><span class="mo">01</span><span class="p">:</span><span class="mo">00</span>
<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">iso8601</span><span class="p">(</span><span class="s2">"2022-06-17T16:00"</span><span class="p">)</span><span class="o">.</span><span class="n">in_time_zone</span><span class="p">(</span><span class="s2">"Europe/London"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="no">Fri</span><span class="p">,</span> <span class="mi">17</span> <span class="no">Jun</span> <span class="mi">2022</span> <span class="mi">17</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">000000000</span> <span class="no">BST</span> <span class="o">+</span><span class="mo">01</span><span class="p">:</span><span class="mo">00</span>
<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">iso8601</span><span class="p">(</span><span class="s2">"2022-06-17T16:00"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="no">Fri</span><span class="p">,</span> <span class="mi">17</span> <span class="no">Jun</span> <span class="mi">2022</span> <span class="mi">16</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">000000000</span> <span class="no">UTC</span> <span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span>

<span class="c1"># Specify the timezone as context</span>
<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">find_zone!</span><span class="p">(</span><span class="s2">"Europe/London"</span><span class="p">)</span><span class="o">.</span><span class="n">iso8601</span><span class="p">(</span><span class="s2">"2022-06-17T16:00"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="no">Fri</span><span class="p">,</span> <span class="mi">17</span> <span class="no">Jun</span> <span class="mi">2022</span> <span class="mi">16</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">000000000</span> <span class="no">BST</span> <span class="o">+</span><span class="mo">01</span><span class="p">:</span><span class="mo">00</span>

<span class="c1"># Even "now" should have a timezone context</span>
<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
<span class="o">=&gt;</span> <span class="mi">2023</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mo">07</span> <span class="mi">22</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">34</span><span class="o">.</span><span class="mi">782764</span> <span class="o">+</span><span class="mo">0100</span>
<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zone</span>
<span class="o">=&gt;</span> <span class="s2">"GMT"</span>
<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">name</span>
<span class="o">=&gt;</span> <span class="s2">"UTC"</span>
</pre></div><h3 id="section-dont-pass-around-dates">Don't pass around dates</h3>

        <p>Without a timezone context a date is meaningless:</p>

        <div class="highlight"><pre><span/><span class="o">&gt;</span> <span class="n">beginning_of_day</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">find_zone!</span><span class="p">(</span><span class="s2">"Australia/Sydney"</span><span class="p">)</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">beginning_of_day</span>
<span class="o">=&gt;</span> <span class="no">Fri</span><span class="p">,</span> <span class="mo">07</span> <span class="no">Apr</span> <span class="mi">2023</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">000000000</span> <span class="no">AEST</span> <span class="o">+</span><span class="mi">10</span><span class="p">:</span><span class="mo">00</span>
<span class="o">&gt;</span> <span class="n">date</span> <span class="o">=</span> <span class="n">beginning_of_day</span><span class="o">.</span><span class="n">to_date</span>
<span class="o">=&gt;</span> <span class="no">Fri</span><span class="p">,</span> <span class="mo">07</span> <span class="no">Apr</span> <span class="mi">2023</span>

<span class="c1"># in some other code</span>

<span class="o">&gt;</span> <span class="n">now_somewhere_else</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">iso8601</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">iso8601</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="no">Fri</span><span class="p">,</span> <span class="mo">07</span> <span class="no">Apr</span> <span class="mi">2023</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">000000000</span> <span class="no">UTC</span> <span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span>
<span class="o">&gt;</span> <span class="n">beginning_of_day</span><span class="o">.</span><span class="n">to_i</span> <span class="o">-</span> <span class="n">now_somewhere_else</span><span class="o">.</span><span class="n">to_i</span>
<span class="o">=&gt;</span> <span class="o">-</span><span class="mi">36000</span>
</pre></div><h2 id="section-best-practices">Best practices</h2>

        <h3 id="section-use-strict-methods">Use strict methods</h3>

        <p>Avoid using methods that can silently do the wrong thing:</p>

        <div class="highlight"><pre><span/><span class="c1"># don&#8217;t use this - returns nil</span>
<span class="no">Time</span><span class="o">.</span><span class="n">find_zone</span><span class="p">(</span><span class="s2">"Foo/Bar"</span><span class="p">)</span>

<span class="c1"># don&#8217;t use this - returns nil</span>
<span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TimeZone</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"Foo/Bar"</span><span class="p">)</span>

<span class="c1"># raises TZInfo::InvalidTimezoneIdentifier</span>
<span class="no">TZInfo</span><span class="o">::</span><span class="no">Timezone</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"Foo/Bar"</span><span class="p">)</span>

<span class="c1"># raises ArgumentError</span>
<span class="no">Time</span><span class="o">.</span><span class="n">find_zone!</span><span class="p">(</span><span class="s2">"Foo/Bar"</span><span class="p">)</span>
</pre></div><p>Using methods that raise errors should always be preferred, as if you aren't checking your return values you can end up with more insidious bugs:</p>

        <div class="highlight"><pre><span/><span class="o">&gt;</span> <span class="n">london</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">find_zone</span><span class="p">(</span><span class="s2">"Europe/Londn"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="kp">nil</span>
<span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">find_zone!</span><span class="p">(</span><span class="s2">"UTC"</span><span class="p">)</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">in_time_zone</span><span class="p">(</span><span class="n">london</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="mi">2023</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mo">06</span> <span class="mi">11</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mo">03</span><span class="o">.</span><span class="mi">449456</span> <span class="no">UTC</span>

<span class="c1"># vs</span>

<span class="o">&gt;</span> <span class="n">london</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">find_zone!</span><span class="p">(</span><span class="s2">"Europe/Londn"</span><span class="p">)</span>
<span class="n">lib</span><span class="o">/</span><span class="n">active_support</span><span class="o">/</span><span class="n">core_ext</span><span class="o">/</span><span class="n">time</span><span class="o">/</span><span class="n">zones</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">85</span><span class="ss">:in</span> <span class="sb">`find_zone!':</span>
<span class="sb">Invalid Timezone: Europe/Londn (ArgumentError)</span>
</pre></div><h3 id="section-use-specific-names">Use specific names</h3>

        <p>Prefer specific timezone names, which will also be enforced  by using strict methods. Avoid using legacy names.</p>

        <p> For example: prefer 'America/New_York' to 'US/Eastern' or 'EST5EDT'. This also applies when discussing/specifying timezones. Referring to 'Europe/London' as GMT or 'America/New_York' as EST is wrong about 50% of the year.</p>

        <h3 id="section-test-in-multiple-timezones">Test in multiple timezones</h3>

        <ul>
          <li>Don&#8217;t fall into the trap of Europe/London or UTC being the "one true timezone"</li>
          <li>Test that time-sensitive code works correctly in multiple timezones</li>
          <li>Make use of Timecop to account for DST and any other relevant changes over time</li>
          <li>Make use of the internet or tzinfo to find out when DST happens</li>
        </ul>
      </div></article>
  </main>
    </div>
  </body>
</html>
